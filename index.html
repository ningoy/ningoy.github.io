<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/ningoy.github.io/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/ningoy.github.io/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/ningoy.github.io/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/ningoy.github.io/images/logo.svg" color="#222">

<link rel="stylesheet" href="/ningoy.github.io/css/main.css">


<link rel="stylesheet" href="/ningoy.github.io/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"ningoy.github.io","root":"/ningoy.github.io/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="关爱颈椎成长协会">
<meta property="og:url" content="https://ningoy.github.io/index.html">
<meta property="og:site_name" content="关爱颈椎成长协会">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="关爱颈椎成长协会">

<link rel="canonical" href="https://ningoy.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>关爱颈椎成长协会</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/ningoy.github.io/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">关爱颈椎成长协会</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/ningoy.github.io/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/ningoy.github.io/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ningoy.github.io/2021/06/07/贝叶斯方法-概率编程与贝叶斯推断/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/ningoy.github.io/images/avatar.gif">
      <meta itemprop="name" content="Lenin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="关爱颈椎成长协会">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/ningoy.github.io/2021/06/07/贝叶斯方法-概率编程与贝叶斯推断/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-06-07 10:26:58" itemprop="dateCreated datePublished" datetime="2021-06-07T10:26:58+08:00">2021-06-07</time>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>410</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>简单来说，贝叶斯推断就是通过新得到的证据不断更新你的信念。</p>
<p>在贝叶斯的世界观中，概率是被解释为我们对一件事情发生的相信程度，换句话说，这表明了我们对此事件发生的信心。</p>
<p>频率学派眼中的概率是事件在长时间内发生的频率，比如飞机事故的概率指的是长期来看飞机事故的频率值。但是对某些没有长期频率的事件来说，这样解释是难以理解的。比如竞选时，某位候选人获选的概率，实际上这次竞选在现实中只会发生一次。而贝叶斯学派把概率解释为对事件发生的信心，如果概率为0则表示完全确定此事一定不会发生。</p>
<p>我们永远只能了解部分的真相，但可以不断收集证据来完善我们对事物的观念。</p>
<p>贝叶斯公式 <span class="math display">\[
P(A|X) = \frac{P(X|A)P(A)}{P(X)}
\]</span></p>
<p><span class="math display">\[
\begin{align}
P(X) &amp; = P(X\,and\,A) + P(X\,and\,~A)
\\[3pt]
&amp; = P(X|A)P(A) + P(X|~A)P(~A)
\end{align}
\]</span></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ningoy.github.io/2021/06/04/使用ARIMA模型进行时间序列分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/ningoy.github.io/images/avatar.gif">
      <meta itemprop="name" content="Lenin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="关爱颈椎成长协会">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/ningoy.github.io/2021/06/04/使用ARIMA模型进行时间序列分析/" class="post-title-link" itemprop="url">使用ARIMA模型进行时间序列分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-06-04 17:54:00" itemprop="dateCreated datePublished" datetime="2021-06-04T17:54:00+08:00">2021-06-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-07 10:26:58" itemprop="dateModified" datetime="2021-06-07T10:26:58+08:00">2021-06-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/ningoy.github.io/categories/时序预测/" itemprop="url" rel="index"><span itemprop="name">时序预测</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>8.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>8 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="arima模型">ARIMA模型</h1>
<p>ARIMA模型，自回归移动平均模型（ARIMA，Autoregressive Integrated Moving Average Model），是统计模型中最常见的一种用来进行时间序列预测的模型，旨在描绘数据的自回归性（autocorrelations）。如果观测值并非彼此独立，一个观测值可能会在i个时间单位后与另一个观测值相关，形成一种称为自相关的关系。自相关可以削减基于时间的预测模型（例如时间序列图）的准确性，并导致数据的错误解释。</p>
<p>在引入ARIMA模型之前，我们需要先讨论平稳性（stationarity）和差分时间序列（differencing time series）的相关知识。</p>
<h2 id="平稳性和差分">平稳性和差分</h2>
<p>平稳的时间序列的性质不随观测时间的变化而变化。因此具有趋势或季节性的时间序列不是平稳时间序列——趋势和季节性使得时间序列在不同时段呈现不同特质。与他们相反，白噪声序列（white noise series）则是平稳的——不管观测的时间如何变化，它看起来都应该是一样的。</p>
<p>在判断平稳性上，下面这个例子容易让人混淆：如果一个循环变化的时间序列没有趋势和季节性，那么它仍然是平稳的。这是因为这些循环变化并没有一个固定的周期，因此在进行观测之前我们无法知道循环变化的峰值和谷值会出现在哪个位置。</p>
<p>一般而言，一个平稳的时间序列从长期来看不存在可预测的特征。它的时间曲线图（time plots）反映出这个序列近似于水平（尽管可能存在一些周期性的变化）并保持固定的方差。</p>
<figure>
<img src="http://wxbfans-ink.oss-cn-beijing.aliyuncs.com/img/stationary-1.png?x-oss-process=PicGo" alt="图中的时间序列有哪些是平稳的？（a）连续292天的谷歌股价; （b）连续292天谷歌股价的每日变化量; （c）美国各年的罢工总次数; （d）美国独立家庭住宅的每月价格; （e）按不变美元计算的美国的鸡蛋价格; （e）每月在澳大利亚维多利亚州被屠宰的猪的数量; （g）每年在加拿大西北的麦肯齐河停留的猞猁数量; （h）澳大利亚每月啤酒产量; （i）澳大利亚每月发电量"><figcaption aria-hidden="true">图中的时间序列有哪些是平稳的？（a）连续292天的谷歌股价; （b）连续292天谷歌股价的每日变化量; （c）美国各年的罢工总次数; （d）美国独立家庭住宅的每月价格; （e）按不变美元计算的美国的鸡蛋价格; （e）每月在澳大利亚维多利亚州被屠宰的猪的数量; （g）每年在加拿大西北的麦肯齐河停留的猞猁数量; （h）澳大利亚每月啤酒产量; （i）澳大利亚每月发电量</figcaption>
</figure>
<blockquote>
<p>图 8.1: 图中的时间序列有哪些是平稳的？（a）连续292天的谷歌股价; （b）连续292天谷歌股价的每日变化量; （c）美国各年的罢工总次数; （d）美国独立家庭住宅的每月价格; （e）按不变美元计算的美国的鸡蛋价格; （e）每月在澳大利亚维多利亚州被屠宰的猪的数量; （g）每年在加拿大西北的麦肯齐河停留的猞猁数量; （h）澳大利亚每月啤酒产量; （i）澳大利亚每月发电量</p>
</blockquote>
<p>考虑图<a href="http://wxbfans-ink.oss-cn-beijing.aliyuncs.com/img/stationary-1.png?x-oss-process=PicGo" target="_blank" rel="noopener">8.1</a>中的九个时间序列，其中有哪些是平稳的时间序列？</p>
<p>显然存在季节性的序列（d）、（h）和（i）可以被排除。存在趋势的序列（a）、（c）、（e）、（f）和（i）也应该被排除，除此之外，序列（i）的方差随时间增大，也不符合平稳时间序列的性质。用上述方法排除后，剩下的（b）和（g）是平稳时间序列。</p>
<p>序列（g）的循环变化让它第一眼看上去不太平稳，但是这种变化其实是不定期的——当猞猁的数量超过食物承载的上限时，它们会停止繁殖从而使得数量回落到非常低的水平，之后食物来源的再生使得猞猁数量重新增长，周而复始。从长期来看，这种循环的时间点是不能预测的，因此序列（g）是平稳的。</p>
<h3 id="差分">差分</h3>
<p>在图 <a href="http://wxbfans-ink.oss-cn-beijing.aliyuncs.com/img/stationary-1.png?x-oss-process=PicGo" target="_blank" rel="noopener">8.1</a>中，我们注意到（a）中谷歌股价数并不平稳，但（b）中谷歌股价每天的变化量则是平稳的。这向我们展示了一种让非平稳时间序列变平稳的方法——计算相邻观测值之间的差值，这种方法被称为<strong>差分</strong>。</p>
<p>诸如对数变换的变换方法可用于平稳化（stabilize）时间序列的方差。差分则可以通过去除时间序列中的一些变化特征来平稳化它的均值，并因此消除（或减小）时间序列的趋势和季节性。</p>
<p>和时间曲线图一样，自相关图（ACF图）也能帮助我们识别非平稳时间序列。 对于一个平稳时间序列，自相关系数（ACF）会快速的下降到接近 0 的水平，然而非平稳时间序列的自相关系数会下降的比较缓慢。同样的，非平稳时间序列的 <span class="math inline">\(r_1\)</span> 通常非常大并且为正值。</p>
<p><img src="https://wxbfans-ink.oss-cn-beijing.aliyuncs.com/img/20210606013141.png?x-oss-process=PicGo" alt="谷歌股价（左图）和谷歌股价的每日变化（右图）的自相关系数。" style="zoom:67%;"></p>
<blockquote>
<p>图 8.2: 谷歌股价（左图）和谷歌股价的每日变化（右图）的自相关系数。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> yfinance <span class="keyword">as</span> yf</span><br><span class="line"><span class="keyword">import</span> statsmodels.api <span class="keyword">as</span> sm</span><br><span class="line">goog = yf.download(<span class="string">"GOOG"</span>, start=<span class="string">"2013-01-01"</span>, end=<span class="string">"2013-12-06"</span>)</span><br><span class="line">sm.stats.acorr_ljungbox(goog[<span class="string">'Close'</span>] - goog[<span class="string">'Open'</span>], lags=[<span class="number">10</span>], return_df=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 		lb_stat		lb_pvalue</span></span><br><span class="line"><span class="comment"># 10	10.498818	0.397872</span></span><br></pre></td></tr></table></figure>
<p>差分后的谷歌股价的自相关图看起来像白噪声序列。所有自回归系数都在95%的置信度以内，并且 Ljung-Box 检验中 <span class="math inline">\(Q^*\)</span> 统计量的<em>p</em>值为 0.355 (for <span class="math inline">\(h=10\)</span>)。这反映出谷歌股价的<em>每日变化</em>在本质上是一个与过去时间无关的随机值。</p>
<h3 id="随机游走模型">随机游走模型</h3>
<p>差分序列是指原序列的连续观测值之间的<em>变化值</em>组成的时间序列，它可以被表示为： <span class="math display">\[
y&#39;_t = y_t - y_{t-1}.
\]</span> 差分序列的长度为 <span class="math inline">\(T-1\)</span>，因为<span class="math inline">\(t=1\)</span>时，公式中的差值无法计算。</p>
<p>当差分序列是白噪声时，原序列的模型可以表示为： <span class="math display">\[
y_t - y_{t-1} = \varepsilon_t,
\]</span> 这里的<span class="math inline">\(\varepsilon_t\)</span>为白噪声。调整上式，即可得到“随机游走”模型： <span class="math display">\[
y_t = y_{t-1} + \varepsilon_t.
\]</span> 随机游走模型在非平稳时间序列数据中应用广泛，特别是金融和经济数据。典型的随机游走通常具有以下特征：</p>
<ul>
<li>长期的明显上升或下降趋势。</li>
<li>游走方向上突然的、不能预测的变化。</li>
</ul>
<p>由于未来变化是不可预测的，随机游走模型的预测值为上一次观测值，并且其上升和下降的可能性相同。因此，随机游走模型适用于朴素（naive）的预测。</p>
<p>通过稍许改进，我们可以让差值均值不为零。从而： <span class="math display">\[
y_t - y_{t-1} = c + \varepsilon_t\quad\text{or}\quad {y_t = c + y_{t-1} + \varepsilon_t}\: .
\]</span> <span class="math inline">\(c\)</span>值是连续观测值变化的平均值。如果<span class="math inline">\(c\)</span>值为正，则之前的平均变化情况是增长的，因此<span class="math inline">\(y_t\)</span>将倾向于继续向上漂移（drift）。反之如果<span class="math inline">\(c\)</span>值为负，<span class="math inline">\(y_t\)</span>将倾向于向下漂移。</p>
<h3 id="二阶差分">二阶差分</h3>
<p>有时差分后的数据仍然不平稳，所以可能需要再一次对数据进行差分来得到一个平稳的序列： <span class="math display">\[
\begin{align*}
  y&#39;&#39;_{t}  &amp;=  y&#39;_{t}  - y&#39;_{t - 1} \\
           &amp;= (y_t - y_{t-1}) - (y_{t-1}-y_{t-2})\\
           &amp;= y_t - 2y_{t-1} +y_{t-2}.
\end{align*}
\]</span> 在这种情况下，序列<span class="math inline">\(y_t&#39;&#39;\)</span>的长度为<span class="math inline">\(T-2\)</span>。之后我们可以对原数据的“变化的变化”进行建模。在现实应用中，通常没有必要进行二阶以上的差分。</p>
<h2 id="季节性差分">季节性差分</h2>
<p>季节性差分是对一个观测值和相对应的前一年的观测值之间进行差分。因此有： <span class="math display">\[
y_t&#39; = y_t - y_{t-m},
\]</span> 其中<span class="math inline">\(m=\)</span>一年中的季节数量。这也被称为“延迟-<span class="math inline">\(m\)</span>差值”，因为相减的两个观测值之间的时间间隔为<span class="math inline">\(m\)</span>。</p>
<p>如果季节性差分数据是白噪声，则原数据可以用一个合适的模型来拟合： <span class="math display">\[
y_t = y_{t-m}+\varepsilon_t.
\]</span> 这个模型的预测值等于对应季节的上一次观测值。换言之，这个模型提供季节性的朴素（naive）预测。</p>
<p>图<a href="https://wxbfans-ink.oss-cn-beijing.aliyuncs.com/img/20210606222125.png?x-oss-process=PicGo" target="_blank" rel="noopener">8.3</a> 中下方的图显示的是 A10（抗糖尿病）药剂在澳大利亚月销售量的对数的季节差值。经过变换和差分，序列变得相对平稳。</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cbind(<span class="string">"销售量 ($百万)"</span> = a10,</span><br><span class="line">      <span class="string">"每月销量对数"</span> = log(a10),</span><br><span class="line">      <span class="string">"每年销量变化对数"</span> = diff(log(a10),<span class="number">12</span>)) %&gt;%</span><br><span class="line">  autoplot(facets=<span class="literal">TRUE</span>) +</span><br><span class="line">    xlab(<span class="string">"年份"</span>) + ylab(<span class="string">""</span>) +</span><br><span class="line">    ggtitle(<span class="string">"抗糖尿病药剂销量"</span>)+</span><br><span class="line">  theme(text = element_text(family = <span class="string">"STHeiti"</span>))+</span><br><span class="line">  theme(plot.title = element_text(hjust = <span class="number">0.5</span>))</span><br></pre></td></tr></table></figure>
<figure>
<img src="https://wxbfans-ink.oss-cn-beijing.aliyuncs.com/img/20210606222125.png?x-oss-process=PicGo" alt="A10（抗糖尿病）药剂销量的对数和季节性差值数据，对数变换稳定了方差，而季节性差分去除了数据的趋势和季节性。"><figcaption aria-hidden="true">A10（抗糖尿病）药剂销量的对数和季节性差值数据，对数变换稳定了方差，而季节性差分去除了数据的趋势和季节性。</figcaption>
</figure>
<blockquote>
<p>图 8.3: A10（抗糖尿病）药剂销量的对数和季节性差值数据，对数变换稳定了方差，而季节性差分去除了数据的趋势和季节性。</p>
</blockquote>
<p>为了区别季节差分和一般的差分，我们有时将一般的差分称为“一步差分”，即差值的延迟期数为 1。</p>
<p>正如图<a href="https://wxbfans-ink.oss-cn-beijing.aliyuncs.com/img/20210606222427.png?x-oss-process=PicGo" target="_blank" rel="noopener">8.4</a>所示，我们有时会同时使用季节性差分和一般的差分方法来得到平稳时间序列。在图中，我们先对数据进行对数变换（第二幅图），之后进行季节性差分（第三幅图）。经过上述操作后的数据仍然看起来有点非平稳，所以我们又进行了一次差分（第四幅图）。</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cbind(<span class="string">"十亿千瓦时"</span> = usmelec,</span><br><span class="line">      <span class="string">"对数"</span> = log(usmelec),</span><br><span class="line">      <span class="string">"季节性\n 差分对数"</span> = diff(log(usmelec),<span class="number">12</span>),</span><br><span class="line">      <span class="string">"二次\n 差分对数"</span> = diff(diff(log(usmelec),<span class="number">12</span>),<span class="number">1</span>)) %&gt;%</span><br><span class="line">  autoplot(facets=<span class="literal">TRUE</span>) +</span><br><span class="line">    xlab(<span class="string">"年份"</span>) + ylab(<span class="string">""</span>) +</span><br><span class="line">    ggtitle(<span class="string">"美国电网每月发电量"</span>)+</span><br><span class="line">  theme(text = element_text(family = <span class="string">"STHeiti"</span>))+</span><br><span class="line">  theme(plot.title = element_text(hjust = <span class="number">0.5</span>))</span><br></pre></td></tr></table></figure>
<figure>
<img src="https://wxbfans-ink.oss-cn-beijing.aliyuncs.com/img/20210606222427.png?x-oss-process=PicGo" alt="第一幅图：美国电网每月发电量 (十亿千瓦时)。其他图显示的是该数据经过不同的变换和差分后的情况。"><figcaption aria-hidden="true">第一幅图：美国电网每月发电量 (十亿千瓦时)。其他图显示的是该数据经过不同的变换和差分后的情况。</figcaption>
</figure>
<blockquote>
<p>图 8.4: 第一幅图：美国电网每月发电量 (十亿千瓦时)。其他图显示的是该数据经过不同的变换和差分后的情况。</p>
</blockquote>
<p>选择使用哪些差分方式具有一定的主观性。图<a href="https://otexts.com/fppcn/stationarity.html#fig:a10diff" target="_blank" rel="noopener">8.3</a>中季节性差分的数据看起来和图<a href="https://otexts.com/fppcn/stationarity.html#fig:usmelec" target="_blank" rel="noopener">8.4</a>中季节性差分的数据差异并不大。在后一种情况中，我们可能会使用季节性差分后的数据，而不是进一步对数据进行差分。在前一种情况中，我们也可能认为季节性差分后的数据仍然不够平稳，因而进一步进行差分。我们将在后文中讨论一些严谨的差分检验，然而选择使用何种方式仍然是一个主观选择的过程，不同的分析师可能会做出不同的选择。</p>
<p>假如用<span class="math inline">\(y&#39;_t = y_t - y_{t-m}\)</span>表示季节性的差分序列，那么它的二阶差分序列则为： <span class="math display">\[
\begin{align*}
y&#39;&#39;_t &amp;= y&#39;_t - y&#39;_{t-1} \\
      &amp;= (y_t - y_{t-m}) - (y_{t-1} - y_{t-m-1}) \\
      &amp;= y_t -y_{t-1} - y_{t-m} + y_{t-m-1}\:
\end{align*}
\]</span> 当季节性差值和第一差值都被使用时，两者的先后顺序并不会影响结果——变换顺序后的结果仍是一样的。然而，如果数据的季节性特征比较强，我们建议先进行季节性差分，因为有时经过季节性差分的数据已经足够平稳，没有必要进行后续的差分。如果先进行第一差分，我们仍将需要做一次季节性差分。</p>
<p>当我们使用差分时，有一点非常重要：差值应该是可解释（interpretable）的。第一差分是相邻观测值之间的差值，季节性差分是相邻年份的观测值的变化。其他延迟期数的差分很难和这两者一样易于解释，因此应该尽力避免。</p>
<h3 id="单位根检验">单位根检验</h3>
<p><em>单位根检验</em>是一种更客观的判定是否需要差分的方法。这个针对平稳性的统计假设检验被用于判断是否需要差分方法来让数据更平稳。</p>
<p>单位根检验的方法有很多种，它们基于不同的假设，因此可能产生相互矛盾的结果。在我们的分析中，采用 <em>Kwiatkowski-Phillips-Schmidt-Shin (KPSS)</em> 检验(Kwiatkowski, Phillips, Schmidt, &amp; Shin, <a href="https://otexts.com/fppcn/stationarity.html#ref-KPSS92" target="_blank" rel="noopener">1992</a>)。在此检验中，原假设为数据是平稳的，我们要寻找能够证明原假设是错误的证据。因此，很小的P值（例如小于0.05）说明需要进行差分。该检验可以使用程序包<a href="https://www.statsmodels.org/stable/index.html" target="_blank" rel="noopener"><strong>statsmodels</strong></a>中的 <code>statsmodels.tsa.stattools.kpss()</code> 函数进行计算。</p>
<p>例如，让我们对谷歌的股价数据进行该检验。</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">from statsmodels.tsa.stattools import kpss</span><br><span class="line">import pandas as pd</span><br><span class="line">import yfinance as yf</span><br><span class="line">data = yf.download(<span class="string">"GOOG"</span>, start=<span class="string">"2013-01-01"</span>, end=<span class="string">"2013-12-06"</span>)</span><br><span class="line">kpss_output = pd.Series(kpss(data[<span class="string">'Close'</span>], regression=<span class="string">'c'</span>)[<span class="number">0</span>:<span class="number">3</span>], </span><br><span class="line">          index=[<span class="string">'Test Statistic'</span>, <span class="string">'p-value'</span>, <span class="string">'Lags used'</span>])</span><br><span class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> kpss(data[<span class="string">'Close'</span>], regression=<span class="string">'c'</span>)[<span class="number">3</span>].items():</span><br><span class="line">    kpss_output[<span class="string">'Critical Value (%s)'</span> % key] = value</span><br><span class="line">kpss_output</span><br><span class="line"><span class="comment"># Test Statistic            1.280268</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># p-value                   0.010000</span></span><br><span class="line"><span class="comment"># Lags used                15.000000</span></span><br><span class="line"><span class="comment"># Critical Value (10%)      0.347000</span></span><br><span class="line"><span class="comment"># Critical Value (5%)       0.463000</span></span><br><span class="line"><span class="comment"># Critical Value (2.5%)     0.574000</span></span><br><span class="line"><span class="comment"># Critical Value (1%)       0.739000</span></span><br><span class="line"><span class="comment"># dtype: float64</span></span><br></pre></td></tr></table></figure>
<p>检验统计量的值远大于临界值 1%，可以拒绝原假设，也就是说，该序列不平稳。我们可以对数据进行差分，再次进行检验。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> statsmodels.tsa.stattools <span class="keyword">import</span> kpss</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> yfinance <span class="keyword">as</span> yf</span><br><span class="line">data = yf.download(<span class="string">"GOOG"</span>, start=<span class="string">"2013-01-01"</span>, end=<span class="string">"2013-12-06"</span>)</span><br><span class="line">kpss_output = pd.Series(kpss(data[<span class="string">'Close'</span>] - data[<span class="string">'Open'</span>], regression=<span class="string">'c'</span>)[<span class="number">0</span>:<span class="number">3</span>], </span><br><span class="line">          index=[<span class="string">'Test Statistic'</span>, <span class="string">'p-value'</span>, <span class="string">'Lags used'</span>])</span><br><span class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> kpss(data[<span class="string">'Close'</span>] - data[<span class="string">'Open'</span>], regression=<span class="string">'c'</span>)[<span class="number">3</span>].items():</span><br><span class="line">    kpss_output[<span class="string">'Critical Value (%s)'</span> % key] = value</span><br><span class="line">kpss_output</span><br><span class="line"><span class="comment"># Test Statistic            0.088083</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># p-value                   0.100000</span></span><br><span class="line"><span class="comment"># Lags used                15.000000</span></span><br><span class="line"><span class="comment"># Critical Value (10%)      0.347000</span></span><br><span class="line"><span class="comment"># Critical Value (5%)       0.463000</span></span><br><span class="line"><span class="comment"># Critical Value (2.5%)     0.574000</span></span><br><span class="line"><span class="comment"># Critical Value (1%)       0.739000</span></span><br><span class="line"><span class="comment"># dtype: float64</span></span><br></pre></td></tr></table></figure>
<p>这次检验的统计量的值很小，处在期望的范围以内，因此可以推断出差分后的序列是平稳的。</p>
<p>函数<code>ndiffs</code>可以通过一系列的KPSS检验来确定合适的一阶差分次数。</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ndiffs(goog)</span><br><span class="line"><span class="comment">#&gt; [1] 1</span></span><br></pre></td></tr></table></figure>
<p>从上面的 KPSS 检验可以看出，需要进行一次差分来让<code>goog</code>数据变得平稳。</p>
<p>与上述函数类似，<code>nsdiffs</code>函数可以用来确定是否需要进行季节性差分，它通过季节性强度来确定合适的季节性差分次数，如果<span class="math inline">\(F_S&lt;0.64\)</span>，不需要进行季节性差分，否则需要进行一次季节性差分。</p>
<p>对美国月度用电数据使用<code>nsdiffs()</code>函数。</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">usmelec %&gt;% log() %&gt;% nsdiffs()</span><br><span class="line"><span class="comment">#&gt; [1] 1</span></span><br><span class="line">usmelec %&gt;% log() %&gt;% diff(lag=<span class="number">12</span>) %&gt;% ndiffs()</span><br><span class="line"><span class="comment">#&gt; [1] 1</span></span><br></pre></td></tr></table></figure>
<p>由于<code>nsdiffs()</code>函数返回 1，（说明需要进行一次季节性差分），我们对季节差分后的数据运行<code>ndiffs()</code>函数。这些函数的运行结果说明我们应该进行一次季节性差分和一次一步差分。</p>
<h3 id="参考文献">参考文献</h3>
<p>Hyndman R J, Athanasopoulos G. Forecasting: principles and practice[M]. OTexts, 2018.</p>
<p>ARIMA模型的优缺点，优点是模型十分简单，只需要内生变量而不需要借助其他外生变量。以最简单的模型 Y = aX + b 为例，X 是自变量，Y是因变量，a 和 b 都是外生变量，是由模型的外部因素决定的。</p>
<p>缺点：</p>
<ol type="1">
<li>要求时序数据是稳定的（stationary），或者通过差分化（differencing）后是稳定的。</li>
<li>本质上只能捕捉线性关系，而不能捕捉非线性关系。</li>
</ol>
<p>那么要如何判断时序数据是稳定的呢？</p>
<p>一个时间序列的随机变量是稳定的，当且仅当它的统计特征都是独立于时间的（是关于时间的常量）。</p>
<ol type="1">
<li>稳定的数据是没有趋势（trend），没有周期性（seasonality）的；即它的均值，在时间轴上拥有常量的振幅，并且它的方差，在时间轴上是趋于同一个稳定的值的。</li>
<li>可以用Dickey-Fuller Test 进行假设检验。</li>
</ol>
<p>ARIMA的参数与数学形式</p>
<p>ARIMA模型有三个参数p,d,q</p>
<ul>
<li>p -- 代表预测模型中采用的时序数据本身的滞后数（lags），也叫做AR/Auto-Regressive项。</li>
<li>d -- 代表时序数据需要进行几阶差分化才是稳定的，也叫Integrated项。</li>
<li>q -- 代表预测模型中采用的预测误差的滞后数（lags），也叫MA/Moving Average项。</li>
</ul>
<p>差分 -- 假设y表示t时刻的Y的差分</p>
<p>ARIMA的预测模型可以表示为：</p>
<p>Y的预测值 = 常量c and/or 一个或多个最近时间的Y的加权 and/or 一个或多个最近时间的预测误差。</p>
<p>假设p,q,d已知：</p>
<p>ARIMA用数学形式表示为: <span class="math display">\[
ytˆ=μ+ϕ1∗yt−1+...+ϕp∗yt−p+θ1∗et−1+...+θq∗et−q
其中,ϕ表示AR的系数，θ表示MA的系数
\]</span> ARIMA模型的几个特例</p>
<ol type="1">
<li><p>ARIMA(0,1,0) = random walk:</p>
<p>当d=1,p 和 q 为0 时，叫做random walk，每一个时刻的Y，只与上一时刻的Y有关。 <span class="math display">\[
Yˆt=μ+Yt−1
\]</span></p></li>
<li><p>ARIMA(1,0,0) = first-order autoregressive model:</p>
<p>当p=1,d=0,q=0,说明时序数据是稳定的和自相关的。一个时刻的Y值只与上一个时刻的Y值有关 <span class="math display">\[
Yˆt=μ+ϕ1∗Yt−1.where, ϕ∈[−1,1],是一个斜率系数
\]</span></p></li>
<li><p>ARIMA(1,1,0) = differenced first-order autoregressive model: p=1,d=1,q=0. 说明时序数据在一阶差分化之后是稳定的和自回归的。即一个时刻的差分（y）只与上一个时刻的差分有关。 <span class="math display">\[
yˆt=μ+ϕ1∗yt−1结合一阶差分的定义，也可以表示为：Yˆt−Yt−1=μ+ϕ1∗(Yt−1−Yt−2)或者Yˆt=μ+Yt−1+ϕ1∗(Yt−1−Yt−2)
\]</span></p></li>
<li><p>ARIMA(0,1,1) = simple exponential smoothing with growth. p=0, d=1 ,q=1.说明数据在一阶差分后市稳定的和移动平均的。即一个时刻的估计值的差分与上一个时刻的预测误差有关。 <span class="math display">\[
  yˆt=μ+α1∗et−1注意q=1的差分yt与p=1的差分yt的是不一样的其中，yˆt=Yˆt−Yˆt−1, et−1=Yt−1−Yˆt−1,设θ1=1−α1则也可以写成：Yˆt=μ+Yˆt−1+α1(Yt−1−Yˆt−1)=μ+Yt−1−θ1∗et−1
\]</span></p></li>
<li><p>ARIMA(2,1,2) 在通过上面的例子，可以很轻松的写出它的预测模型： <span class="math display">\[
yˆt=μ+ϕ1∗yt−1+ϕ2∗yt−2−θ1∗et−1−θ2∗et−2也可以写成:Yˆt=μ+ϕ1∗(Yt−1−Yt−2)+ϕ2∗(Yt−2−Yt−3)−θ1∗(Yt−1−Yˆt−1)−θ2∗(Yt−2−Yˆt−2)
\]</span></p></li>
<li><p>ARIMA(2,2,2) <span class="math display">\[
yˆt=μ+ϕ1∗yt−1+ϕ2∗yt−2−θ1∗et−1−θ2∗et−2Yˆt=μ+ϕ1∗(Yt−1−2Yt−2+Yt−3)+ϕ2∗(Yt−2−2Yt−3+Yt−4)−θ1∗(Yt−1−Yˆt−1)−θ2∗(Yt−2−Yˆt−2)
\]</span></p></li>
</ol>
<p>ARIMA建模基本步骤</p>
<ol type="1">
<li>获取被观测系统时间序列数据；</li>
<li>对数据绘图，观测是否为平稳时间序列；对于非平稳时间序列要先进行d阶差分运算，化为平稳时间序列；</li>
<li>经过第二步处理，已经得到平稳时间序列。要对平稳时间序列分别求得其自相关系数ACF 和偏自相关系数PACF，通过对自相关图和偏自相关图的分析，得到最佳的阶层 p 和阶数 q</li>
<li>由以上得到的d、q、p，得到ARIMA模型。然后开始对得到的模型进行模型检验。</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ningoy.github.io/2020/03/27/处理数据常用的命令行工具/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/ningoy.github.io/images/avatar.gif">
      <meta itemprop="name" content="Lenin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="关爱颈椎成长协会">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/ningoy.github.io/2020/03/27/处理数据常用的命令行工具/" class="post-title-link" itemprop="url">处理数据常用的命令行工具</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-27 23:03:09" itemprop="dateCreated datePublished" datetime="2020-03-27T23:03:09+08:00">2020-03-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-28 14:52:27" itemprop="dateModified" datetime="2021-05-28T14:52:27+08:00">2021-05-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/ningoy.github.io/categories/数据挖掘/" itemprop="url" rel="index"><span itemprop="name">数据挖掘</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/ningoy.github.io/categories/数据挖掘/数据清洗/" itemprop="url" rel="index"><span itemprop="name">数据清洗</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="head-tail">head &amp; tail</h4>
<hr>
<ol type="1">
<li><p><code>head</code> 默认打印出文件的前<code>10</code> 行，<code>tail</code> 默认打印出文件的最后<code>10</code> 行。</p></li>
<li><p>也可以使用<code>head -n 5 shakespeare_6.0.json</code> 或是 <code>head -5 shakespeare_6.0.json</code> 打印出前<code>5</code> 行。用<code>tail -n 5 shakespeare_6.0.json</code> 或 <code>tail -5 shakespeare_6.0.json</code> 打印出文件最后<code>5</code> 行。</p></li>
<li><p><code>head -n 10010 listings.csv | tail -10</code> 和 <code>tail -n +10001 listings.csv | head -n 10</code> 表示同一个意思，即是打印 <code>10001-10010</code> 行。</p></li>
<li><p><code>tail -f listings.csv</code> 这个命令既打印 <code>listings.csv</code> 文件的最后<code>10</code> 行，也能在<code>listings.csv</code> 文件行数增长时，继续打印新增的行。</p></li>
</ol>
<h4 id="tr">tr</h4>
<hr>
<ol type="1">
<li><p><code>head -n 10 listings.csv | tr ',' '\t'</code> 可以将<code>.csv</code> 文件中的<code>,</code> 分隔符换成<code>\t</code> 分隔符。</p></li>
<li><p><code>head -n 10 listings.csv | tr -d ','</code> 可以将<code>.csv</code> 文件中的<code>,</code> 分隔符去掉。</p></li>
<li><p><code>head -n 10 listings.csv | tr "[:lower:]" "[:upper:]"</code> 可以将 <code>.csv</code> 文件中的小写字母换成大写字母，而这是通过<code>[:class:]</code> 做到的。</p>
<ul>
<li><code>[:alnum:]</code> 所有字母和数字</li>
</ul></li>
</ol>
<ul>
<li><code>[:alpha:]</code> 所有字母
<ul>
<li><code>[:blank:]</code> 所有水平空白</li>
</ul></li>
<li><code>[:cntrl:]</code> 所有控制字符
<ul>
<li><code>[:digit:]</code> 所有数字</li>
</ul></li>
<li><code>[:graph:]</code> 所有可打印字符，但不包括空格
<ul>
<li><code>[:lower:]</code> 所有小写字母</li>
</ul></li>
<li><code>[:print:]</code> 所有可打印字符，包括空格
<ul>
<li><code>[:punct:]</code> 所有标点符号</li>
</ul></li>
<li><code>[:space:]</code> 所有水平或垂直空白
<ul>
<li><code>[:upper:]</code> 所有大写字母</li>
</ul></li>
<li><code>[:xdigit:]</code> 所有 16 进制数字</li>
</ul>
<h4 id="wc">wc</h4>
<hr>
<ol type="1">
<li><code>wc -l listings.csv</code> 打印 <code>listings.csv</code> 的行数。</li>
</ol>
<h4 id="sort-uniq">sort &amp; uniq</h4>
<hr>
<ol type="1">
<li><p><code>uniq</code> 只作用于重复的相邻行，因此最好先对要处理的文件进行<code>sort</code> 。</p></li>
<li><p><code>head -500 listings.csv | awk -F ',' '{print $6}' | sort | uniq -c | sort -nr</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> sort 先排序，使得重复的行相邻便于uniq统计</span><br><span class="line"><span class="meta">#</span> 之后uniq -c 统计每一行重复的次数</span><br><span class="line"><span class="meta">#</span> 再通过sort -nr降序排列</span><br><span class="line"><span class="meta">#</span> 这样可以很快找到重复次数最多的一行</span><br><span class="line">    201 朝阳区 / Chaoyang</span><br><span class="line">     65 东城区</span><br><span class="line">     53 </span><br><span class="line">     34 海淀区</span><br><span class="line">     27 西城区</span><br><span class="line">     24 丰台区 / Fengtai</span><br><span class="line">     14 顺义区 / Shunyi</span><br><span class="line">     12 昌平区</span><br><span class="line">     12 怀柔区 / Huairou</span><br><span class="line">      6 通州区 / Tongzhou</span><br><span class="line">      5 密云县 / Miyun</span><br></pre></td></tr></table></figure></li>
<li><p><code>head -10 reviews.csv | tr ',' ' ' | sort -t" " -k2,2</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> -t 选项将" "指定为分隔符</span><br><span class="line"><span class="meta">#</span> -k 选项用来确定排序的键</span><br><span class="line"><span class="meta">#</span> -k2,2 意为 第2列为开始列 第2列为结束列</span><br><span class="line">44054 2010-08-25</span><br><span class="line">44054 2010-10-13</span><br><span class="line">44054 2011-08-11</span><br><span class="line">44054 2012-04-12</span><br><span class="line">44054 2012-08-30</span><br><span class="line">44054 2012-09-28</span><br><span class="line">44054 2012-10-04</span><br><span class="line">44054 2012-11-15</span><br><span class="line">44054 2013-03-08</span><br><span class="line">listing_id date</span><br></pre></td></tr></table></figure></li>
<li><p><code>head -n +100 reviews.csv | tail -10  | tr ',' ' ' | sort -t" " -k1n,1</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> -k1n,1 意为 第1列为开始列 第2列为结束列 同时第一列为数字 采用数字大小排序</span><br><span class="line">100213 2017-08-27</span><br><span class="line">100213 2017-10-08</span><br><span class="line">128496 2011-06-02</span><br><span class="line">128496 2011-06-05</span><br><span class="line">128496 2011-08-02</span><br><span class="line">128496 2011-08-26</span><br><span class="line">128496 2011-09-04</span><br><span class="line">128496 2011-09-07</span><br><span class="line">128496 2011-09-12</span><br><span class="line">128496 2011-09-19</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="cut">cut</h4>
<hr>
<ol type="1">
<li><code>cut</code> 用于选择列，<code>cut -d',' -f 1,3 listings.csv | head -10</code> 选择第1列和第3列。</li>
<li><code>head listings.csv | cut -d ',' -f 6-</code> 选择第6列以后的（包括第6列）所有列。</li>
</ol>
<h4 id="jq">jq</h4>
<hr>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">head -n 4 shakespeare_6.0.json</span><br><span class="line"></span><br><span class="line">&#123;"index":&#123;"_index":"shakespeare","_id":0&#125;&#125;</span><br><span class="line">&#123;"type":"act","line_id":1,"play_name":"Henry IV", "speech_number":"","line_number":"","speaker":"","text_entry":"ACT I"&#125;</span><br><span class="line">&#123;"index":&#123;"_index":"shakespeare","_id":1&#125;&#125;</span><br><span class="line">&#123;"type":"scene","line_id":2,"play_name":"Henry IV","speech_number":"","line_number":"","speaker":"","text_entry":"SCENE I. London. The palace."&#125;</span><br><span class="line"></span><br><span class="line">head -n 4 shakespeare_6.0.json | jq</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "index": &#123;</span><br><span class="line">    "_index": "shakespeare",</span><br><span class="line">    "_id": 0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">  "type": "act",</span><br><span class="line">  "line_id": 1,</span><br><span class="line">  "play_name": "Henry IV",</span><br><span class="line">  "speech_number": "",</span><br><span class="line">  "line_number": "",</span><br><span class="line">  "speaker": "",</span><br><span class="line">  "text_entry": "ACT I"</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">  "index": &#123;</span><br><span class="line">    "_index": "shakespeare",</span><br><span class="line">    "_id": 1</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">  "type": "scene",</span><br><span class="line">  "line_id": 2,</span><br><span class="line">  "play_name": "Henry IV",</span><br><span class="line">  "speech_number": "",</span><br><span class="line">  "line_number": "",</span><br><span class="line">  "speaker": "",</span><br><span class="line">  "text_entry": "SCENE I. London. The palace."</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">head -n 4 shakespeare_6.0.json | jq ".text_entry"</span><br><span class="line"></span><br><span class="line">null</span><br><span class="line">"ACT I"</span><br><span class="line">null</span><br><span class="line">"SCENE I. London. The palace."</span><br></pre></td></tr></table></figure>
<h4 id="sed-awk">sed &amp; awk</h4>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ningoy.github.io/2018/05/05/561-Array-Partition-I/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/ningoy.github.io/images/avatar.gif">
      <meta itemprop="name" content="Lenin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="关爱颈椎成长协会">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/ningoy.github.io/2018/05/05/561-Array-Partition-I/" class="post-title-link" itemprop="url">561. Array Partition I</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-05-05 15:42:00" itemprop="dateCreated datePublished" datetime="2018-05-05T15:42:00+08:00">2018-05-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-28 14:52:27" itemprop="dateModified" datetime="2021-05-28T14:52:27+08:00">2021-05-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/ningoy.github.io/categories/刷题/" itemprop="url" rel="index"><span itemprop="name">刷题</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/ningoy.github.io/categories/刷题/LeetCode/" itemprop="url" rel="index"><span itemprop="name">LeetCode</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>708</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>Given an array of <strong>2n</strong> integers, your task is to group these integers into <strong>n</strong> pairs of integer, say (a1, b1), (a2, b2), ..., (an, bn) which makes sum of min(ai, bi) for all i from 1 to n as large as possible.</p>
</blockquote>
<p><strong>Example 1:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Input: [1,4,3,2]</span><br><span class="line"></span><br><span class="line">Output: 4</span><br><span class="line">Explanation: n is 2, and the maximum sum of pairs is 4 = min(1, 2) + min(3, 4).</span><br></pre></td></tr></table></figure>
<p><strong>Note:</strong></p>
<ol type="1">
<li><strong>n</strong> is a positive integer, which is in the range of [1, 10000].</li>
<li>All the integers in the array will be in the range of [-10000, 10000].</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">arrayPairSum</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> res = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span>[] count = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">20001</span>];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i : nums)&#123;</span><br><span class="line">            count[i + <span class="number">10000</span>]++;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">boolean</span> odd = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count.length; i++)&#123;</span><br><span class="line">            <span class="keyword">while</span>(count[i] &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(odd)&#123;</span><br><span class="line">                    res += i - <span class="number">10000</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                odd = !odd;</span><br><span class="line">                count[i]--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ningoy.github.io/2018/03/24/面试题2：实现Singleton模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/ningoy.github.io/images/avatar.gif">
      <meta itemprop="name" content="Lenin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="关爱颈椎成长协会">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/ningoy.github.io/2018/03/24/面试题2：实现Singleton模式/" class="post-title-link" itemprop="url">面试题2：实现Singleton模式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-03-24 17:22:02" itemprop="dateCreated datePublished" datetime="2018-03-24T17:22:02+08:00">2018-03-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-28 14:52:27" itemprop="dateModified" datetime="2021-05-28T14:52:27+08:00">2021-05-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/ningoy.github.io/categories/刷题/" itemprop="url" rel="index"><span itemprop="name">刷题</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/ningoy.github.io/categories/刷题/剑指Offer/" itemprop="url" rel="index"><span itemprop="name">剑指Offer</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="一什么是单例模式">一、什么是单例模式</h3>
<p>因程序需要，有时我们只需要某个类同时保留一个对象，不希望有更多对象，此时，我们则应该考虑单例模式的设计。</p>
<h3 id="二单例模式的特点">二、单例模式的特点</h3>
<ol type="1">
<li>单例模式只能有一个实例。</li>
<li>单例模式必须创建自己的唯一实例。</li>
<li>单例模式必须向其他对象提供这一实例。</li>
</ol>
<h3 id="三单例模式-vs-静态类">三、单例模式 vs 静态类</h3>
<ol type="1">
<li>单例模式可以继承和被继承，方法可以被override，而静态方法不可以。</li>
<li>静态方法中产生的对象会在执行后被释放，进而被GC清理，不会一直存在于内存中。</li>
<li>静态类会在第一次运行时初始化，单例模式可以有其他的选择，即可以延迟加载。</li>
<li>基于2、3条，由于单例对象往往存在于DAO层，如果反复的初始化和释放，则会占用很多资源，而使用单例模式将其常驻于内存可以更加节约资源。</li>
<li>静态方法有更高的访问效率。</li>
<li>单例模式很容易被测试。</li>
</ol>
<p>几个关于静态类的误解：</p>
<ul>
<li>静态方法常驻内存而实例方法不是。
<ul>
<li>实际上，特殊编写的实例方法可以常驻内存，而静态方法需要不断初始化和释放。</li>
</ul></li>
<li>静态方法在堆(heap)上，实例方法在栈(stack)上。
<ul>
<li>实际上，都是加载到特殊的不可写的代码内存区域中</li>
</ul></li>
<li>静态类和单例模式情景的选择
<ul>
<li>不需要维持任何状态，仅仅用于全局访问，此时更适合使用静态类。</li>
<li>需要维持一些特定的状态，此时更适合使用单例模式。</li>
</ul></li>
</ul>
<h3 id="四单例模式的实现">四、单例模式的实现</h3>
<ol type="1">
<li><p>懒汉模式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SingletonDemo instance;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingletonDemo</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingletonDemo <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(instance==<span class="keyword">null</span>)&#123;</span><br><span class="line">            instance=<span class="keyword">new</span> SingletonDemo();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上，通过提供一个静态的对象<code>instance</code>，利用<code>private</code>权限的构造方法和<code>getInstance()</code>方法来给予访问者一个单例。</p>
<p>缺点是，没有考虑到线程安全，可能存在多个访问者同时访问，并同时构造了多个对象的问题。之所以叫做懒汉模式，主要是因为此种方法可以非常明显的lazy loading。</p>
<p>针对懒汉模式线程不安全的问题，我们自然想到了，在 <code>getInstance()</code> 方法前加锁，于是就有了第二种实现.</p></li>
<li><p>线程安全的懒汉模式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SingletonDemo instance;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingletonDemo</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> SingletonDemo <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(instance==<span class="keyword">null</span>)&#123;</span><br><span class="line">            instance=<span class="keyword">new</span> SingletonDemo();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然而并发其实是一种特殊情况，大多时候这个锁占用的额外资源都浪费了，这种打补丁方式写出来的结构效率很低。</p></li>
<li><p>饿汉模式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SingletonDemo instance=<span class="keyword">new</span> SingletonDemo();</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingletonDemo</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingletonDemo <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接在运行这个类的时候进行一次loading，之后直接访问。显然，这种方法没有起到lazy loading的效果，考虑到前面提到的和静态类的对比，这种方法只比静态类多了一个内存常驻而已。</p></li>
<li><p>静态类内部加载</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonHolder</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> SingletonDemo instance=<span class="keyword">new</span> SingletonDemo();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingletonDemo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Singleton has loaded"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingletonDemo <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SingletonHolder.instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>枚举方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> SingletonDemo&#123;</span><br><span class="line">    INSTANCE;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">otherMethods</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Something"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Effective Java作者Josh Bloch 提倡的方式，在我看来简直是来自神的写法。解决了以下三个问题：</p>
<p>(1)自由序列化。</p>
<p>(2)保证只有一个实例。</p>
<p>(3)线程安全。</p>
<p>如果我们想调用它的方法时，仅需要以下操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        SingletonDemo.INSTANCE.otherMethods();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>双重校验锁法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> SingletonDemo instance;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingletonDemo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Singleton has loaded"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingletonDemo <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(instance==<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (SingletonDemo.class)&#123;</span><br><span class="line">                <span class="keyword">if</span>(instance==<span class="keyword">null</span>)&#123;</span><br><span class="line">                    instance=<span class="keyword">new</span> SingletonDemo();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来我解释一下在并发时，双重校验锁法会有怎样的情景：</p>
<p>STEP 1. 线程A访问<code>getInstance()</code>方法，因为单例还没有实例化，所以进入了锁定块。</p>
<p>STEP 2. 线程B访问<code>getInstance()</code>方法，因为单例还没有实例化，得以访问接下来代码块，而接下来代码块已经被线程1锁定。</p>
<p>STEP 3. 线程A进入下一判断，因为单例还没有实例化，所以进行单例实例化，成功实例化后退出代码块，解除锁定。</p>
<p>STEP 4. 线程B进入接下来代码块，锁定线程，进入下一判断，因为已经实例化，退出代码块，解除锁定。</p>
<p>STEP 5. 线程A获取到了单例实例并返回，线程B没有获取到单例并返回Null。</p>
<p>理论上双重校验锁法是线程安全的，并且，这种方法实现了<code>lazyloading</code>。</p></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ningoy.github.io/2017/11/29/导入CSV文件到MySQL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/ningoy.github.io/images/avatar.gif">
      <meta itemprop="name" content="Lenin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="关爱颈椎成长协会">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/ningoy.github.io/2017/11/29/导入CSV文件到MySQL/" class="post-title-link" itemprop="url">导入CSV文件到MySQL</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-11-29 19:37:44" itemprop="dateCreated datePublished" datetime="2017-11-29T19:37:44+08:00">2017-11-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-28 14:52:27" itemprop="dateModified" datetime="2021-05-28T14:52:27+08:00">2021-05-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/ningoy.github.io/categories/数据挖掘/" itemprop="url" rel="index"><span itemprop="name">数据挖掘</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/ningoy.github.io/categories/数据挖掘/数据集选取或构建/" itemprop="url" rel="index"><span itemprop="name">数据集选取或构建</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>从网上下载了一个<a href="https://www.capitalbikeshare.com/system-data" target="_blank" rel="noopener">公开数据集</a>，想要用来做一点小实验。下载之后发现这是一个<code>.csv</code>格式的文件，里面大概有50多万条数据。那么下一步就是要把这些数据导入到数据库里。</p>
<h3 id="方案一">方案一</h3>
<p>用<code>python</code>的<code>pymysql</code>库来操作，先连接数据库，然后创建数据表，再构造出<code>sql</code>语句，把数据一条一条导进去。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    start = time.time()</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'2016-Q1-Trips-History-Data.csv'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> csv_file:</span><br><span class="line">        spam_reader = csv.reader(csv_file, delimiter=<span class="string">','</span>)</span><br><span class="line">        headers = next(spam_reader)</span><br><span class="line">        db = pymysql.connect(<span class="string">'localhost'</span>, <span class="string">'username'</span>, <span class="string">'password'</span>, <span class="string">'tripshistorydata'</span>)</span><br><span class="line">        cursor = db.cursor()</span><br><span class="line">        cursor.execute(<span class="string">'DROP TABLE IF EXISTS temp;'</span>)</span><br><span class="line">        sql = <span class="string">"""</span></span><br><span class="line"><span class="string">            create table temp(</span></span><br><span class="line"><span class="string">            Duration int not null,</span></span><br><span class="line"><span class="string">            StartDate char(50) not null,</span></span><br><span class="line"><span class="string">            EndDate char(50) not null,</span></span><br><span class="line"><span class="string">            StartStationNumber int not null,</span></span><br><span class="line"><span class="string">            StartStation char(100) not null,</span></span><br><span class="line"><span class="string">            EndStationNumber int not null,</span></span><br><span class="line"><span class="string">            EndStation char(100) not null,</span></span><br><span class="line"><span class="string">            BikeNumber Char(50) not null,</span></span><br><span class="line"><span class="string">            MemberType char(50) not null);</span></span><br><span class="line"><span class="string">            """</span></span><br><span class="line">        cursor.execute(sql)</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> spam_reader:</span><br><span class="line">            param = (</span><br><span class="line">                int(row[<span class="number">0</span>]), row[<span class="number">1</span>], row[<span class="number">2</span>], int(row[<span class="number">3</span>]), row[<span class="number">4</span>], int(row[<span class="number">5</span>]), row[<span class="number">6</span>], row[<span class="number">7</span>], row[<span class="number">8</span>]</span><br><span class="line">            )</span><br><span class="line">            sql = <span class="string">"""insert into temp(</span></span><br><span class="line"><span class="string">            Duration, StartDate, EndDate, StartStationNumber, StartStation, EndStationNumber, EndStation, BikeNumber, MemberType</span></span><br><span class="line"><span class="string">            ) values(%s, %s, %s, %s, %s, %s, %s, %s, %s);"""</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                cursor.execute(sql, param)</span><br><span class="line">                db.commit()</span><br><span class="line">                <span class="comment"># 记住这句话</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                print(e)</span><br><span class="line">                db.rollback()</span><br><span class="line">        </span><br><span class="line">        db.close()</span><br><span class="line">    stop = time.time()</span><br><span class="line">    cost = stop - start</span><br><span class="line">    print(cost)</span><br></pre></td></tr></table></figure>
<p>但是吧，这么写实在太慢，睡了一个午觉还没导入完。那不行啊，那么有没有更快的办法呢？</p>
<h3 id="方案二">方案二</h3>
<p>答案当然是有的，为什么会那么慢，那是因为每一次<code>insert</code>的时候都会<code>commit</code>一次，这样当然会消耗很多时间。如果等所有数据都<code>insert</code>之后，只执行一次<code>commit</code>，当然就会快很多了。</p>
<p>然后嘞，还可以去<code>my.ini</code>里修改<code>innodb_flush_log_at_trx_commit</code>这么一个参数。</p>
<ul>
<li><p>当<code>innodb_flush_log_at_trx_commit=1</code>时，每次事务提交时MySQL都会把<code>log buffer</code>的数据写入<code>log file</code>，并且flush，该模式为系统默认。</p>
<blockquote>
<p>该模式是最安全的，但也是最慢的一种方式。在<code>mysqld</code>服务崩溃或者服务器主机<code>crash</code>的情况下，<code>binary log</code>只有可能丢失最多一个语句或者一个事务。</p>
</blockquote></li>
<li><p>当<code>innodb_flush_log_at_trx_commit=0</code>时，<code>log buffer</code>将每秒一次地写入<code>log file</code>中，并且<code>log file</code>的flush操作同时进行。该模式下在事务提交的时候，不会主动触发写入磁盘的操作。</p>
<blockquote>
<p>该模式速度最快，但不太安全，<code>mysqld</code>进程的崩溃会导致上一秒钟所有事务数据的丢失。</p>
</blockquote></li>
<li><p>当<code>innodb_flush_log_at_trx_commit=2</code>时，每次事务提交时MySQL都会把<code>log buffer</code>的数据写入<code>log file</code>，但是flush操作并不会同时进行。该模式下，MySQL会每秒执行一次 flush操作。</p>
<blockquote>
<p>该模式速度较快，也比<code>innodb_flush_log_at_trx_commit=0</code>安全，只有在操作系统崩溃或者系统断电的情况下，上一秒钟所有事务数据才可能丢失。</p>
</blockquote></li>
</ul>
<p>综合起来，设置<code>innodb_flush_log_at_trx_commit=2</code>，然后重启MySQL服务器</p>
<p>看看这次需要多长的时间。</p>
<p><font color="red">264.5988073348999s</font></p>
<h3 id="方案三">方案三</h3>
<p><strong>MySQL有一个高效的导入方法，那就是<code>load data infile</code>。 </strong></p>
<p>语法如下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span>  [<span class="keyword">low_priority</span>] [<span class="keyword">local</span>] <span class="keyword">infile</span> <span class="string">'file_name txt'</span> [<span class="keyword">replace</span> | <span class="keyword">ignore</span>]</span><br><span class="line"><span class="keyword">into</span> <span class="keyword">table</span> tbl_name</span><br><span class="line">[<span class="keyword">fields</span></span><br><span class="line">[<span class="keyword">terminated</span> <span class="keyword">by</span><span class="string">'t'</span>]</span><br><span class="line">[<span class="keyword">OPTIONALLY</span>] <span class="keyword">enclosed</span> <span class="keyword">by</span> <span class="string">''</span>]</span><br><span class="line">[<span class="keyword">escaped</span> <span class="keyword">by</span><span class="string">'\' ]]</span></span><br><span class="line"><span class="string">[lines terminated by'</span>n<span class="string">']</span></span><br><span class="line"><span class="string">[ignore number lines]</span></span><br><span class="line"><span class="string">[(col_name,   )]</span></span><br></pre></td></tr></table></figure>
<p><code>load data infile</code>语句从一个文本文件中以很高的速度读入一个表中。使用这个命令之前，<code>mysqld</code>进程（服务）必须已经在运行。为了安全原因，当读取位于服务器上的文本文件时，文件必须处于数据库目录或可被所有人读取。另外，为了对服务器上文件使用<code>load data infile</code>，在服务器主机上你必须有<code>file</code>的权限。</p>
<ol type="1">
<li>如果你指定关键词<code>low_priority</code>，那么MySQL将会等到没有其他人读这个表的时候，才把插入数据。</li>
<li>如果指定<code>local</code>关键词，则表明从客户主机读文件。如果没指定<code>local</code>，文件必须位于服务器上。</li>
<li><code>replace</code>和<code>ignore</code>关键词控制对现有的唯一键记录的重复的处理。如果你指定<code>replace</code>，新行将代替有相同的唯一键值的现有行。如果你指定<code>ignore</code>，跳过有唯一键的现有行的重复行的输入。如果你不指定任何一个选项，当找到重复键时，出现一个错误，并且文本文件的余下部分被忽略。</li>
<li>分隔符
<ol type="1">
<li><code>fields</code>关键字指定了文件记段的分割格式，如果用到这个关键字，MySQL剖析器希望看到至少有下面的一个选项：</li>
</ol>
<ul>
<li><code>terminated by</code> 字段的分隔符</li>
<li><code>enclosed by</code> 字段括起字符</li>
<li><code>escaped by</code> 转义字符<br>
</li>
</ul></li>
</ol>
<p>代码如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LOAD</span> <span class="keyword">DATA</span> <span class="keyword">LOCAL</span> <span class="keyword">INFILE</span> <span class="string">'FileName'</span> <span class="keyword">REPLACE</span> </span><br><span class="line"><span class="keyword">INTO</span> <span class="keyword">TABLE</span> TableName</span><br><span class="line"><span class="keyword">FIELDS</span> </span><br><span class="line"><span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">','</span> </span><br><span class="line"><span class="keyword">OPTIONALLY</span> <span class="keyword">ENCLOSED</span> <span class="keyword">BY</span> <span class="string">''</span></span><br><span class="line"><span class="keyword">LINES</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'\n'</span></span><br><span class="line"><span class="keyword">IGNORE</span> <span class="number">1</span> <span class="keyword">lines</span>;</span><br></pre></td></tr></table></figure>
<p><font color="red">64.813s</font></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ningoy.github.io/2017/11/11/Uploadify插件的使用及兼容性/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/ningoy.github.io/images/avatar.gif">
      <meta itemprop="name" content="Lenin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="关爱颈椎成长协会">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/ningoy.github.io/2017/11/11/Uploadify插件的使用及兼容性/" class="post-title-link" itemprop="url">Uploadify插件的使用及兼容性</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-11-11 19:02:59" itemprop="dateCreated datePublished" datetime="2017-11-11T19:02:59+08:00">2017-11-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-28 14:52:27" itemprop="dateModified" datetime="2021-05-28T14:52:27+08:00">2021-05-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/ningoy.github.io/categories/错误、调试和测试/" itemprop="url" rel="index"><span itemprop="name">错误、调试和测试</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/ningoy.github.io/categories/错误、调试和测试/调试/" itemprop="url" rel="index"><span itemprop="name">调试</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="情境">情境</h2>
<p>要把一个使用Java编写的免费开源的轻量级CMS系统部署到服务器上，主要包括后台权限系统、CMS栏目系统、内容发布系统、简约风格换肤系统。这个系统选用的技术如下：</p>
<table>
<thead>
<tr class="header">
<th>后端</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>核心框架</td>
<td>Spring Framework 4.2.5</td>
</tr>
<tr class="even">
<td>安全框架</td>
<td>Apache Shiro 1.3.2</td>
</tr>
<tr class="odd">
<td>视图框架</td>
<td>Spring MVC 4.2.5</td>
</tr>
<tr class="even">
<td>缓存框架</td>
<td>Ehcache</td>
</tr>
<tr class="odd">
<td>数据库连接池</td>
<td>Tomcat JDBC</td>
</tr>
<tr class="even">
<td>ORM框架</td>
<td>Spring Data JPA、Hibernate 4.3.5</td>
</tr>
<tr class="odd">
<td>日志管理</td>
<td>SLF4J 1.7.21、Log4j</td>
</tr>
<tr class="even">
<td>编辑器</td>
<td>ueditor</td>
</tr>
<tr class="odd">
<td>工具类</td>
<td>Apache Commons、Jackson 2.8.5、POI 3.15</td>
</tr>
<tr class="even">
<td>view层</td>
<td>JSP</td>
</tr>
<tr class="odd">
<td>数据库</td>
<td>MySQL、Oracle等关系型数据库</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr class="header">
<th>前端</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>DOM</td>
<td>jquery</td>
</tr>
<tr class="even">
<td>分页</td>
<td>jquery</td>
</tr>
<tr class="odd">
<td>UI管理</td>
<td>common</td>
</tr>
<tr class="even">
<td>UI集成</td>
<td>uiExtend</td>
</tr>
<tr class="odd">
<td>滚动条</td>
<td>jquery.nicescroll.min.js</td>
</tr>
<tr class="even">
<td>图表</td>
<td>highcharts</td>
</tr>
<tr class="odd">
<td>3D图表</td>
<td>highcharts-more</td>
</tr>
<tr class="even">
<td>轮播图</td>
<td>jquery-swipe</td>
</tr>
<tr class="odd">
<td>表单提交</td>
<td>jquery.form</td>
</tr>
<tr class="even">
<td>文件上传</td>
<td>jquery.uploadify</td>
</tr>
<tr class="odd">
<td>表单验证</td>
<td>jquery.validator</td>
</tr>
<tr class="even">
<td>展现树</td>
<td>jquery.ztree</td>
</tr>
<tr class="odd">
<td>html模版引擎</td>
<td>template</td>
</tr>
</tbody>
</table>
<p>在系统后台发布文章的时候，可以为文章添加一个封面<code>CoverImageUrl</code>。然而，当我选中本地的图片，点击上传之后，却发现图片并没有上传。点击保存之后，前台页面也没有出现文章的封面。</p>
<h2 id="思路">思路</h2>
<ol type="1">
<li><p>搞明白自己遇到的问题是什么？</p>
<ul>
<li>在系统的后台管理界面发布文章时，给文章添加封面。实质上就是 一个上传图片（图片从本地移动到系统指定的路径下），并把图片的相关数据存进数据库的一个过程。</li>
<li>当浏览器访问文章时，再从数据库中取出图片的相关数据，渲染出来就可以了。</li>
</ul></li>
<li><p>搞明白是哪里出了问题？</p>
<ul>
<li><p>从数据流来看，图片数据就是经过前端到达后台再进入数据库的。那么是这中间的哪一环出了问题？</p></li>
<li><p>首先检查数据库，文章封面对应的字段<code>CoverImageUrl</code>的值没有变化，说明没有改变数据库的数据。</p></li>
<li><p>然后调试后台的Java代码<code>UploadController.java</code>，发现数据根本就没有传到后台。这就说明是在前台出问题的。</p></li>
<li><p>那么检查前台的代码，盯着看了很久还是没有发现问题，调试的时候发现，数据甚至没有传到前台的代码里，百思不得其解，在这个地方卡了很久。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"l_title w200"</span>&gt;</span>图片：<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"J_toolsBar fl"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">" w200 ml10"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span> </span><br><span class="line">          <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">id</span>=<span class="string">"attachImage"</span> /&gt;</span> </span><br><span class="line">        <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">"#attachImage"</span>).uploadify(</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">'swf'</span> : <span class="string">'$&#123;pageContext.request.contextPath&#125;/static/js/uploadify/uploadify.swf'</span>,</span><br><span class="line">			<span class="string">'uploader'</span> : <span class="string">'$&#123;pageContext.request.contextPath&#125;/upload/uploadAttach'</span>,</span><br><span class="line">			<span class="string">'cancelImg'</span> : <span class="string">'$&#123;pageContext.request.contextPath&#125;/static/js/uploadify/uploadify-cancel.png'</span>,</span><br><span class="line">			<span class="string">'queueID'</span> : <span class="string">'fileQueue'</span>,</span><br><span class="line">			<span class="string">'auto'</span> : <span class="literal">true</span>,</span><br><span class="line">			<span class="string">'multi'</span> : <span class="literal">false</span>,</span><br><span class="line">			<span class="string">'simUploadLimit'</span> : <span class="number">1</span>,</span><br><span class="line">			<span class="string">'buttonText'</span> : <span class="string">'上传图片'</span>,</span><br><span class="line">			<span class="string">'fileObjName'</span> : <span class="string">'fileData'</span>,</span><br><span class="line">			<span class="string">'width'</span> : <span class="number">70</span>,</span><br><span class="line">			<span class="string">'height'</span> : <span class="number">20</span>,</span><br><span class="line">			<span class="string">'uploadLimit'</span>:<span class="number">3</span>,</span><br><span class="line">			<span class="string">'onUploadSuccess'</span> : <span class="function"><span class="keyword">function</span>(<span class="params">file, data, response</span>) </span>&#123;</span><br><span class="line">					<span class="keyword">if</span>(data != <span class="literal">null</span>)&#123;</span><br><span class="line">						<span class="keyword">var</span> attachUrl = <span class="string">'$&#123;pageContext.request.contextPath&#125;'</span> + data;								</span><br><span class="line">						$(<span class="string">"#attachURL"</span>).attr(<span class="string">'src'</span>,attachUrl); </span><br><span class="line">						$(<span class="string">"#coverImageUrl"</span>).val(data);</span><br><span class="line">					&#125;</span><br><span class="line">		 &#125;</span><br><span class="line">	   &#125;);</span><br></pre></td></tr></table></figure></li>
<li><p>后来灵机一动，直接搜索<code>uploadify</code>，了解了一下这个控件。发现有很多使用这个控件无法上传图片的情况，一个一个点进去看，有关于jQuery包的导入顺序的，有基于cookie信息验证身份的等等，最后确定是flash插件没有更新，终于把这个问题解决了。</p></li>
</ul></li>
<li><p>总结一下检查的步骤</p>
<ol type="1">
<li><strong>检查是否安装Flash插件</strong>
<ul>
<li>如果检查完毕，发现没有安装，需要根据你浏览器类别，浏览器版本来进行下载对应的Flash版本，这也就是该插件的一大坑，Flash插件强关联操作系统，强关联浏览器类别，强关联具体某一类浏览器的版本。如，实际兼容Firefox4.0过程中，Flash版本对应Flash for Firefox 10，其他的版本安装上也不能使用。即IE，Firefox，chrome需要下载不同的Flash安装。</li>
</ul></li>
<li><strong>Firefox兼容问题</strong>
<ul>
<li>在项目中，处于安全性考虑，每次请求必然会做合法性校验，即请求经过相关过滤器，而登录过滤器会根据<code>sessionid</code>获取用户session登录信息。而Firefox使用Flash上传文件时，Flash本身的bug导致提交时不会带上<code>session cookie</code>，而HTTP是无状态请求，session的存在以客户端和服务端的交换标志而延续。而session的<code>sessionid</code>是存储在cookie中的，导致请求不合法。</li>
<li>解决方案一
<ul>
<li>采用插件自身的<code>formData</code>属性实现</li>
</ul></li>
<li>解决方案二
<ul>
<li>在原有请求后加上<code>;jsessionid=${pageContext.session.id}</code></li>
</ul></li>
</ul></li>
</ol></li>
</ol>
<h2 id="总结">总结</h2>
<p><strong>最后总结一下Debug之道</strong></p>
<ul>
<li>首先要摸清楚数据流，搞明白问题出在哪里。</li>
<li>要科学地利用搜索工具，你遇到的问题，别人有可能已经遇到过了，并早已经把解决方案发布在互联网上了。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ningoy.github.io/2017/10/30/你只有10只小白鼠和一星期的时间，如何检验出哪个瓶子里有毒药？/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/ningoy.github.io/images/avatar.gif">
      <meta itemprop="name" content="Lenin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="关爱颈椎成长协会">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/ningoy.github.io/2017/10/30/你只有10只小白鼠和一星期的时间，如何检验出哪个瓶子里有毒药？/" class="post-title-link" itemprop="url">你只有10只小白鼠和一星期的时间，如何检验出哪个瓶子里有毒药？</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-10-30 19:12:27" itemprop="dateCreated datePublished" datetime="2017-10-30T19:12:27+08:00">2017-10-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-28 14:52:27" itemprop="dateModified" datetime="2021-05-28T14:52:27+08:00">2021-05-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/ningoy.github.io/categories/数学/" itemprop="url" rel="index"><span itemprop="name">数学</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/ningoy.github.io/categories/数学/趣味数学/" itemprop="url" rel="index"><span itemprop="name">趣味数学</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>485</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>有 1000 个一模一样的瓶子，其中有 999 瓶是普通的水，有一瓶是毒药。任何喝下毒药的生物都会在一星期之后死亡。现在，你只有 10 只小白鼠和一星期的时间，如何检验出哪个瓶子里有毒药？</p>
</blockquote>
<ol type="1">
<li><p>把1000瓶标号：1, 2, 3, 4, 5, 6 ...1000。</p></li>
<li><p>所有老鼠排列在一起组成一个2进制队列: 0000000000，其中0代表不喝，1代表喝。</p></li>
<li><p>0000000001代表第一瓶水被喝情况</p>
<p>0000000010代表第二瓶水被喝情况</p>
<p>0000000011代表第三瓶水被喝情况</p>
<p>0000000100代表第四瓶水被喝情况</p>
<p>...</p>
<p>1111101000代表第1000瓶水被喝情况</p></li>
<li><p>第7天，喝了毒药的老鼠都死了，那个二进制队列转为为十进制就是毒药的标号。</p></li>
</ol>
<p>比如第3只老鼠死亡，其他老鼠没死，队列为0000000100，第四瓶水有毒。第1, 5, 6, 8老鼠死亡，其他没死，队列为0010110001，第177瓶水有毒。</p>
<p>作者：kirch</p>
<p>链接：https://www.zhihu.com/question/19676641/answer/14123096</p>
<p>来源：知乎著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ningoy.github.io/2017/10/26/MySQL中删除重复数据只保留一条/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/ningoy.github.io/images/avatar.gif">
      <meta itemprop="name" content="Lenin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="关爱颈椎成长协会">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/ningoy.github.io/2017/10/26/MySQL中删除重复数据只保留一条/" class="post-title-link" itemprop="url">MySQL中删除重复数据只保留一条</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-10-26 11:24:58" itemprop="dateCreated datePublished" datetime="2017-10-26T11:24:58+08:00">2017-10-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-28 14:52:27" itemprop="dateModified" datetime="2021-05-28T14:52:27+08:00">2021-05-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/ningoy.github.io/categories/数据挖掘/" itemprop="url" rel="index"><span itemprop="name">数据挖掘</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/ningoy.github.io/categories/数据挖掘/数据清洗/" itemprop="url" rel="index"><span itemprop="name">数据清洗</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="mysql中删除重复数据只保留一条">MySQL中删除重复数据只保留一条</h1>
<h2 id="情境">情境</h2>
<p>数据库中有一张表<code>bone</code> ，有如下字段</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lblCollectionUnicode, lblTitleName, lblRegisterType, lblType, lblFunctions, lblDimension, lblChineseDisplay, lblWestDisplay, lblDescription, imgShowImage</span><br></pre></td></tr></table></figure>
<p>其中有几条数据因为插入了多次，所以是完全重复的，现在要求去除掉重复数据只保留一条。</p>
<h3 id="思路">思路</h3>
<p>首先确定一个应该具有唯一性的字段，比如<code>lblCollectionUnicode</code> 。然后利用<code>SELECT</code> 语句找出所有<code>lblCollectionUnicode</code> 字段重复的元组，并依照其<code>lblCollectionUnicode</code> 字段的值进行分组。再利用<code>MIN()</code> 函数找出每个分组中<code>auto_increment</code> 字段（即自动增长字段，必须被定义为主键使用）值最小或最大的元组，将其保留，而将其他数据删去。</p>
<p>由于这张表中还没有<code>auto_increment</code>字段，因此首先要创建这个字段。</p>
<h2 id="实现">实现</h2>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> new_bone <span class="keyword">LIKE</span> bone;   </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> new_bone <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> bone;</span><br></pre></td></tr></table></figure>
<p>首先将表备份。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> bone <span class="keyword">add</span> <span class="keyword">column</span> _id <span class="built_in">int</span> auto_increment <span class="keyword">not</span> <span class="literal">null</span>, <span class="keyword">add</span> primary <span class="keyword">key</span>(_id);</span><br></pre></td></tr></table></figure>
<p>在表<code>bone</code> 中新增一个<code>_id</code> 字段为整型、自动增长、非空，并将其设为主键。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> bone</span><br><span class="line"><span class="keyword">WHERE</span> lblCollectionUnicode <span class="keyword">IN</span> ( <span class="keyword">SELECT</span> * <span class="keyword">FROM</span>(</span><br><span class="line">        <span class="keyword">SELECT</span> lblCollectionUnicode <span class="keyword">FROM</span> bone </span><br><span class="line">        <span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">			lblCollectionUnicode </span><br><span class="line">        <span class="keyword">HAVING</span> </span><br><span class="line">			<span class="keyword">count</span>(lblCollectionUnicode) &gt; <span class="number">1</span> )<span class="keyword">as</span> temp1)</span><br><span class="line"><span class="keyword">AND</span> _id <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span>( </span><br><span class="line">		<span class="keyword">SELECT</span> <span class="keyword">MIN</span>(_id) <span class="keyword">FROM</span> bone </span><br><span class="line">        <span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">			lblCollectionUnicode</span><br><span class="line">		<span class="keyword">HAVING</span></span><br><span class="line">			<span class="keyword">count</span>(lblCollectionUnicode) &gt; <span class="number">1</span> )<span class="keyword">as</span> temp2);</span><br></pre></td></tr></table></figure>
<p>按照<code>lblCollectionUnicode</code> 的取值分组，其中元组数大于1的组有重复数据。利用<code>MIN()</code> 函数取得每组中<code>_id</code> 值最小的元组并将其排除在外，删除元组数大于1的组中的其余数据，即只保留一条数据。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> bone</span><br><span class="line"><span class="keyword">WHERE</span> lblCollectionUnicode <span class="keyword">IN</span> (</span><br><span class="line">        <span class="keyword">SELECT</span> lblCollectionUnicode <span class="keyword">FROM</span> bone </span><br><span class="line">        <span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">			lblCollectionUnicode </span><br><span class="line">        <span class="keyword">HAVING</span> </span><br><span class="line">			<span class="keyword">count</span>(lblCollectionUnicode) &gt; <span class="number">1</span> )</span><br><span class="line"><span class="keyword">AND</span> _id <span class="keyword">NOT</span> <span class="keyword">IN</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> <span class="keyword">MIN</span>(_id) <span class="keyword">FROM</span> bone </span><br><span class="line">        <span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">			lblCollectionUnicode</span><br><span class="line"> 		<span class="keyword">HAVING</span></span><br><span class="line"> 			<span class="keyword">count</span>(lblCollectionUnicode) &gt; <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>MYSQL执行上述语句报错：</p>
<p>报错信息如下：</p>
<p>　　<code>错误代码： 1093</code> 　　<code>You can't specify target table 'bone' for update in FROM clause</code></p>
<p>意思是不能在同一语句中更新select出的同一张表元组的属性值</p>
<p>解决方法：将select出的结果通过中间表再select一遍即可。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> bone <span class="keyword">change</span> _id _id <span class="built_in">INT</span>(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> bone <span class="keyword">DROP</span> PRIMARY <span class="keyword">KEY</span>;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> bone <span class="keyword">ADD</span> PRIMARY <span class="keyword">KEY</span>(lblCollectionUnicode);</span><br></pre></td></tr></table></figure>
<p>删除自增长后再删除主键，然后将<code>lblCollectionUnicode</code> 设置为主键。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ningoy.github.io/2017/10/20/使用子查询和联结表/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/ningoy.github.io/images/avatar.gif">
      <meta itemprop="name" content="Lenin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="关爱颈椎成长协会">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/ningoy.github.io/2017/10/20/使用子查询和联结表/" class="post-title-link" itemprop="url">使用子查询和联结表</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-10-20 19:15:34" itemprop="dateCreated datePublished" datetime="2017-10-20T19:15:34+08:00">2017-10-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-28 14:52:27" itemprop="dateModified" datetime="2021-05-28T14:52:27+08:00">2021-05-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/ningoy.github.io/categories/读书笔记/" itemprop="url" rel="index"><span itemprop="name">读书笔记</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/ningoy.github.io/categories/读书笔记/计算机科学/" itemprop="url" rel="index"><span itemprop="name">计算机科学</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/ningoy.github.io/categories/读书笔记/计算机科学/数据库/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/ningoy.github.io/categories/读书笔记/计算机科学/数据库/MySQL必知必会/" itemprop="url" rel="index"><span itemprop="name">MySQL必知必会</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="使用子查询和联结表">使用子查询和联结表</h1>
<h2 id="使用子查询">使用子查询</h2>
<h3 id="利用子查询进行过滤">利用子查询进行过滤</h3>
<p>假设：</p>
<p>订单存储在两个表中。对于包含订单号、客户ID、订单日期的每个订单，<code>orders</code>表存储一行，各订单的物品存储在相关的<code>orderitems</code>表中。<code>orders</code> 表不存储客户信息。它只存储客户的ID。实际的客户信息存储在<code>customers</code>表中。</p>
<p>现在假如需要列出订购物品<code>TNT2</code> 的所有客户，应该怎样检索？</p>
<ol type="1">
<li>检索包含物品<code>TNT2</code> 的所有订单的编号。</li>
<li>检索具有前一步骤列出的订单编号的所有客户的ID。</li>
<li>检索前一步骤返回的所有客户ID的客户信息。</li>
</ol>
<p>上述每个步骤都可以单独作为一个查询来执行。可以把一条<code>SELECT</code> 语句返回的结果用于另一条<code>SELECT</code> 语句的<code>WHERE</code> 子句。</p>
<p>也可以使用<strong>子查询</strong>来把3个查询组合成一条语句。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> cust_name, cust_contact </span><br><span class="line"><span class="keyword">from</span> customers </span><br><span class="line"><span class="keyword">where</span> cust_id <span class="keyword">in</span> (<span class="keyword">select</span> cust_id </span><br><span class="line">                  <span class="keyword">from</span> orders </span><br><span class="line">                  <span class="keyword">where</span> order_num <span class="keyword">in</span> (<span class="keyword">select</span> order_num </span><br><span class="line">                                      <span class="keyword">from</span> orderitems </span><br><span class="line">                                      <span class="keyword">where</span> prod_id = <span class="string">'TNT2'</span>));</span><br></pre></td></tr></table></figure>
<p>为了执行上述<code>SELECT</code> 语句，MySQL实际上必须执行3条<code>SELECT</code> 语句。最里面的子查询返回订单号列表，此列表用于其外面的子查询的<code>WHERE</code> 子句。外面的子查询返回客户ID列表，此客户ID列表用于最外层查询的<code>WHERE</code> 子句。最外层查询确实返回所需的数据。</p>
<p>可见，在<code>WHERE</code> 子句中使用子查询能够编写出功能很强并且很灵活的SQL语句。对于能嵌套的子查询的数目没有限制，不过由于在实际使用时由于性能的限制，不能嵌套太多的子查询。</p>
<blockquote>
<p><strong>列必须匹配</strong> 在<code>WHERE</code> 子句中使用子查询，应该保证<code>SELECT</code> 语句具有与<code>WHERE</code> 子句中相同数目的列。通常，子查询将返回单个列并且与单个列匹配，但如果需要也可以使用多个列。</p>
</blockquote>
<h3 id="作为计算字段使用子查询">作为计算字段使用子查询</h3>
<p>使用子查询的另一方法是创建计算字段。假如需要显示<code>customers</code> 表中每个客户的订单总数。订单与相应的客户ID存储在<code>orders</code> 表中。</p>
<p>为了执行这个操作，遵循下面的步骤。</p>
<ol type="1">
<li>从<code>customers</code> 表中检索客户列表。</li>
<li>对于检索出的每个客户，统计其在<code>orders</code> 表中的订单数目。</li>
</ol>
<p>为了对每个客户执行<code>COUNT(*)</code> 计算，应该把<code>COUNT(*)</code> 作为一个子查询。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> cust_name, </span><br><span class="line">       cust_state, </span><br><span class="line">       (<span class="keyword">select</span> <span class="keyword">count</span>(*) </span><br><span class="line">       <span class="keyword">from</span> orders </span><br><span class="line">       <span class="keyword">where</span> orders.cust_id = customers.cust_id) <span class="keyword">as</span> orders</span><br><span class="line"><span class="keyword">from</span> customers </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> cust_name;</span><br></pre></td></tr></table></figure>
<p>这条<code>SELECT</code> 语句对<code>customers</code> 表中每个客户返回3列：<code>cust_name</code> 、<code>cust_state</code> 、和<code>orders</code> 。<code>orders</code> 是一个计算字段，它是由圆括号中的子查询建立的。该子查询对检索出的每个客户执行一次。在此例子中，该子查询执行了5次，因为检索出了5个客户。</p>
<p>子查询中的<code>WHERE</code> 子句和前面使用的<code>WHERE</code> 子句稍有不同，因为它使用了完全限定列名。下面的语句告诉SQL比较<code>orders</code> 表中的<code>cust_id</code> 与当前正从<code>customers</code> 表中检索出的<code>cust_id</code> ：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">where orders.cust_id = customers.cust_id</span><br></pre></td></tr></table></figure>
<p><strong>相关子查询 (correlated subquery)</strong> 涉及外部查询的子查询。</p>
<p>这种类型的子查询称为<strong>相关子查询</strong> 。任何时候只要列名可能有多义性，就必须使用这种语法（表名和列名由一个句点分隔）。</p>
<blockquote>
<p><strong>逐渐增加子查询来建立查询 </strong></p>
<p>用子查询测试和调试查询很有技巧性，特别是在这些语句的复杂性不断增加的情况下更是如此。用子查询建立（和测试）查询的最可靠的方法是逐渐进行，这与MySQL处理它们的方法非常相同。首先，建立和测试最内层的查询。然后，用硬编码数据建立和测试外层查询，并且仅在确认它正常后才嵌入子查询。这时，再次测试它。对于要增加的每个查询，重复这些步骤。这样做仅给构造查询增加了一点点时间，但节省了以后（找出查询为什么不正常）的大量时间，并且极大地提高了查询一开始就正常工作的可能性。</p>
</blockquote>
<h2 id="联结表">联结表</h2>
<h2 id="联结">联结</h2>
<p>SQL最强大的功能之一，就是能在数据检索查询的执行中联结（join）表。</p>
<h3 id="关系表">关系表</h3>
<p>理解关系表的最好方法是来看一个现实世界中的例子。</p>
<p>假如有一个包含产品目录的数据库表，其中每种类比的物品占一行。对于每种物品要存储的信息包括产品描述和价格，以及生产该产品的供应商信息。</p>
<p>现在，假如有由同一供应商生产的多种物品，那么在何处存储供应商信息（如，供应商名、地址、联系方式等）呢？将这些数据与产品信息分开存储的理由如下。</p>
<ul>
<li>因为同一供应商生产的每个产品的供应商信息都是相同的，对每个产品重复此信息既浪费时间又浪费存储空间。</li>
<li>如果供应商信息改变（例如，供应商搬家或电话号码变动），只需改动一次即可。</li>
<li>如果有重复数据（即每种商品都储存供应商信息），很难保证每次输入该数据的方式都相同。不一致的数据在报表中很难利用。</li>
</ul>
<p>关键是，相同数据出现多次绝不是一件好事，此因素是关系数据库设计的基础，关系表的设计就是要保证吧信息分解成多个表，一类数据一个表。各表通过某些常用的值（即关系设计中的<strong>关系（relational）</strong>互相关联）</p>
<p>在这个例子中可以建立两个表，一个存储供应商信息，另一个存储产品信息。<code>vendors</code> 表包含所有供应商信息，每个供应商占一行，每个供应商具有唯一的标识，此标识称为<strong>主键（primary key）</strong> ， 可以是供应商ID或任何其他唯一值。</p>
<p><code>products</code>表只存储产品信息，它除了存储供应商ID（<code>vendors</code>表的主键）外不存储其他供应商信息。<code>vendors</code>表的主键又叫做<code>products</code>的外键，它将<code>vendors</code>表与<code>products</code>表相关联，利用供应商ID能从<code>vendors</code>表中找出相应供应商的详细信息。</p>
<blockquote>
<p><strong>外键（foreign key）</strong> 外键为某个表中的一列，它包含另一个表的主键值，定义了两个表之间的关系。</p>
<p>这样做的好处如下：</p>
<ul>
<li>供应商信息不重复，从而不浪费时间和空间；</li>
<li>如果供应商信息变动， 可以只更新<code>vendors</code>表中的单个记录，相关表中的数据不用改动；</li>
<li>由于数据无重复，显然数据是一致的，这使得处理数据更简单。</li>
</ul>
<p>总之，关系数据可以有效的存储和方便的处理。因此，关系数据库的可伸缩性远比非关系数据库要好。</p>
<p><strong>可伸缩性（scale）</strong> 能够适应不断增加的工作量而不失败。设计良好的数据库或应用程序称之为<strong>可伸缩性好（scale well）</strong>。</p>
</blockquote>
<h3 id="为什么要使用联结">为什么要使用联结</h3>
<p>正如所述，分解数据为多个表能更有效地存储，更方便地处理，并且具有更大的可伸缩性。但这些好处是有代价的。</p>
<p>如果数据存储在多个表中，怎样用单条<code>select</code> 语句检索出数据？</p>
<p>答案是使用联结。简单的说，联结是一种机制，用来在一条<code>select</code>语句中关联表 ，因此称之为联结。使用特殊的语法，可以联结多个表返回同一组输出，联结在运行时关联表中正确的行。</p>
<blockquote>
<p><strong>维护引用完整性</strong> 重要的是，要理解联结不是物理实体。换句话说，它在实际的数据库表中并不存在，联结由MySQL根据需要建立，它存在于查询的执行当中。</p>
<p>在使用关系表时，仅在关系列中插入合法的数据非常重要，回到这里的例子，如果在<code>products</code>表中插入非法供应商ID（即没有在<code>vendors</code>表中出现 ）的供应商生产的商品，则这些产品是不可访问的，因为它们没有关联到某个供应商。</p>
<p>为防止这种情况发生，可指示MySQL只允许在<code>products</code>表的供应商ID列中出现合法值（即出现在<code>vendors</code>表中的供应商）。这就是维护引用完整性，它是通过在表的定义中指定主键和外键来实现的。</p>
</blockquote>
<h3 id="创建联结">创建联结</h3>
<p>联结的创建非常简单，规定要联结的所有表以及它们如何关联即可。请看下面的例子：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> vend_name, prod_name, prod_price</span><br><span class="line"><span class="keyword">from</span> vendors, products</span><br><span class="line"><span class="keyword">where</span> vendors.vend_id = products.vend_id</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> vend_name, prod_name;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>完全限定列名</strong> 在引用的列可能出现二义性时，必须使用完全限定列名（用一个点分隔的表名和列名）。如果引用一个没有用表名限制的具有二义性的列名，MySQL将返回错误。</p>
</blockquote>
<h3 id="内部联结">内部联结</h3>
<p>目前为止所用的联结成为<strong>等值联结（equijoin）</strong> ，它基于两个表之间的相等测试。这种联结也称为<strong>内部联结</strong> 。其实对于这种联结可以使用稍微不同的语法来明确指定联结的类型。下面的<code>select</code> 语句返回与前面例子完全相同的数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> vend_name, prod_name, prod_price</span><br><span class="line"><span class="keyword">from</span> vendors <span class="keyword">inner</span> <span class="keyword">join</span> products</span><br><span class="line"><span class="keyword">on</span> vendors.vend_id = products.vend_id;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/ningoy.github.io/page/2/">2</a><a class="extend next" rel="next" href="/ningoy.github.io/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Lenin</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/ningoy.github.io/archives/">
        
          <span class="site-state-item-count">12</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/ningoy.github.io/categories/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/ningoy.github.io/tags/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lenin</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">29k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">26 分钟</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/ningoy.github.io/lib/anime.min.js"></script>
  <script src="/ningoy.github.io/lib/velocity/velocity.min.js"></script>
  <script src="/ningoy.github.io/lib/velocity/velocity.ui.min.js"></script>
<script src="/ningoy.github.io/js/utils.js"></script><script src="/ningoy.github.io/js/motion.js"></script>
<script src="/ningoy.github.io/js/schemes/muse.js"></script>
<script src="/ningoy.github.io/js/next-boot.js"></script>



  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
